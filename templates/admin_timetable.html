<!DOCTYPE html>
<html lang="en">
<head>
    <title>Admin - Manage Timetables</title>
    <script>
        function changeWeek(offset) {
            let form = document.createElement("form");
            form.method = "POST";
            form.style.display = "none";

            let input = document.createElement("input");
            input.type = "hidden";
            input.name = "week_change";
            input.value = offset;

            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }

        function showEditByUser() {
            document.getElementById("editByUser").style.display = "block";
            document.getElementById("editBySubject").style.display = "none";
            document.getElementById("editByYearGroup").style.display = "none";
        }

        function showEditBySubject() {
            document.getElementById("editByUser").style.display = "none";
            document.getElementById("editBySubject").style.display = "block";
            document.getElementById("editByYearGroup").style.display = "none";
        }

        function showEditByYearGroup() {
            document.getElementById("editByUser").style.display = "none";
            document.getElementById("editBySubject").style.display = "none";
            document.getElementById("editByYearGroup").style.display = "block";
        }

        function showUserTimetable(userId) {
            let form = document.createElement("form");
            form.method = "POST";
            form.style.display = "none";

            let input = document.createElement("input");
            input.type = "hidden";
            input.name = "user_id";
            input.value = userId;

            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }

        function showSubjectTimetable(subjectId) {
            let form = document.createElement("form");
            form.method = "POST";
            form.style.display = "none";

            let input = document.createElement("input");
            input.type = "hidden";
            input.name = "subject_id";
            input.value = subjectId;

            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }

        function showYearGroupTimetable(yearGroup) {
            let form = document.createElement("form");
            form.method = "POST";
            form.style.display = "none";

            let input = document.createElement("input");
            input.type = "hidden";
            input.name = "year_group";
            input.value = yearGroup;

            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }

        function showSubjects(userId) {
            fetch(`/get_assigned_subjects/${userId}`)
                .then(response => response.json())
                .then(data => {
                    let subjectsList = document.getElementById("subjectsList");
                    subjectsList.innerHTML = "";
                    data.forEach(subject => {
                        let li = document.createElement("li");
                        li.textContent = subject.name;
                        subjectsList.appendChild(li);
                    });
                    document.getElementById("subjectsMenu").style.display = "block";
                });
        }

        function showStudents(subjectId) {
            fetch(`/get_assigned_users/${subjectId}`)
                .then(response => response.json())
                .then(data => {
                    let studentsList = document.getElementById("studentsList");
                    studentsList.innerHTML = "";
                    data.forEach(user => {
                        let li = document.createElement("li");
                        li.textContent = user.username;
                        studentsList.appendChild(li);
                    });
                    document.getElementById("studentsMenu").style.display = "block";
                });
        }

        function showYearGroupStudents(yearGroup) {
            fetch(`/get_students_by_year_group/${yearGroup}`)
                .then(response => response.json())
                .then(data => {
                    let studentsList = document.getElementById("studentsList");
                    studentsList.innerHTML = "";
                    data.forEach(user => {
                        let li = document.createElement("li");
                        li.textContent = user.username;
                        studentsList.appendChild(li);
                    });
                    document.getElementById("studentsMenu").style.display = "block";
                });
        }

        function showEditForm(entryId) {
            fetch(`/get_entry_details/${entryId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error loading entry details');
                        return;
                    }

                    // Populate form fields
                    document.getElementById('edit_entry_id').value = entryId;
                    document.getElementById('edit_date').value = data.date;
                    document.getElementById('edit_start_time').value = data.start_time;
                    document.getElementById('edit_end_time').value = data.end_time;
                    document.getElementById('edit_subject_id').value = data.subject_id;
                    document.getElementById('edit_teacher_id').value = data.teacher_id;
                    document.getElementById('edit_room_id').value = data.room_id;

                    // Show the modal
                    document.getElementById('editEntryModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading entry details');
                });
        }

        function showDeleteConfirmation(entryId, event) {
            if (event) {
                event.preventDefault();
            }
            
            fetch(`/get_entry_assignees/${entryId}`)
                .then(response => response.json())
                .then(data => {
                    const usersList = document.getElementById('assignedUsersList');
                    usersList.innerHTML = '';
                    data.forEach(user => {
                        const li = document.createElement('li');
                        li.textContent = user.username;
                        usersList.appendChild(li);
                    });
                    document.getElementById('delete_entry_id').value = entryId;
                    document.getElementById('deleteConfirmationModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading user details');
                });
        }

        function manageAssignees() {
            const entryId = document.getElementById('edit_entry_id').value;
            const subjectId = document.getElementById('edit_subject_id').value;

            // Fetch both current assignees and available users
            Promise.all([
                fetch(`/get_entry_assignees/${entryId}`).then(res => res.json()),
                fetch(`/get_subject_users/${subjectId}`).then(res => res.json())
            ]).then(([currentAssignees, subjectUsers]) => {
                const assigneesList = document.getElementById('assigneesList');
                const availableUsersList = document.getElementById('availableUsersList');
                
                assigneesList.innerHTML = '';
                availableUsersList.innerHTML = '';

                // Create a map of current assignees for easy lookup
                const assigneeMap = new Map(currentAssignees.map(user => [user.id, user]));

                // Add all subject users to the list
                subjectUsers.forEach(user => {
                    const isAssigned = assigneeMap.has(user.id);
                    const container = isAssigned ? assigneesList : availableUsersList;
                    
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    div.innerHTML = `
                        <input type="checkbox" id="user_${user.id}" 
                            value="${user.id}" 
                            ${isAssigned ? 'checked' : ''}>
                        <label for="user_${user.id}">${user.username}</label>
                    `;
                    container.appendChild(div);
                });

                document.getElementById('manageAssigneesModal').style.display = 'block';
            });
        }

        function filterUsers() {
            const searchTerm = document.getElementById('assigneeSearch').value.toLowerCase();
            const checkboxItems = document.querySelectorAll('.checkbox-item');
            
            checkboxItems.forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                item.style.display = label.includes(searchTerm) ? '' : 'none';
            });
        }

        function updateAssignees() {
            const entryId = document.getElementById('edit_entry_id').value;
            const checkedUsers = document.querySelectorAll('.checkbox-item input[type="checkbox"]:checked');
            const userIds = Array.from(checkedUsers).map(cb => cb.value);
            
            fetch('/update_entry_assignees', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    entry_id: entryId,
                    user_ids: userIds
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeAssigneesModal();
                    location.reload();
                }
            });
        }

        function closeEditModal() {
            document.getElementById('editEntryModal').style.display = 'none';
        }

        function closeDeleteModal() {
            document.getElementById('deleteConfirmationModal').style.display = 'none';
        }

        function closeAssigneesModal() {
            document.getElementById('manageAssigneesModal').style.display = 'none';
        }

        // Add event listener to the form
        document.getElementById('editEntryForm').addEventListener('submit', function(e) {
            // Form will submit normally - no need to prevent default
            closeEditModal();
        });

        // Add event listener for the delete form
        document.getElementById('deleteConfirmForm').addEventListener('submit', function(e) {
            // Form will submit normally - no need to prevent default
            closeDeleteModal();
        });

        function updateTeacherList() {
            const subjectSelect = document.getElementById('subject_select');
            const isSubstitute = document.getElementById('is_substitute').checked;
            const teacherSelect = document.getElementById('teacher_select');

            // Clear current options
            teacherSelect.innerHTML = '<option value="">Select a teacher</option>';

            // Get teachers based on subject and substitute status
            fetch(`/get_subject_teachers/${subjectSelect.value}?is_substitute=${isSubstitute}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.text = teacher.username;
                        teacherSelect.add(option);
                    });
                });
        }

        // Similar update for the edit form
        function updateEditTeacherList() {
            const subjectSelect = document.getElementById('edit_subject_id');
            const isSubstitute = document.getElementById('edit_is_substitute').checked;
            const teacherSelect = document.getElementById('edit_teacher_id');

            teacherSelect.innerHTML = '<option value="">Select a teacher</option>';

            fetch(`/get_subject_teachers/${subjectSelect.value}?is_substitute=${isSubstitute}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.text = teacher.username;
                        teacherSelect.add(option);
                    });
                });
        }

        function updateTeacherListForSubject() {
            const subjectSelect = document.querySelector('#editBySubject select[name="subject_id"], #timetableForm select[name="subject_id"]');
            const isSubstituteCheckbox = document.getElementById('subject_is_substitute');
            const isSubstitute = isSubstituteCheckbox ? isSubstituteCheckbox.checked : false;
            const teacherSelect = document.getElementById('subject_teacher_select');

            if (!subjectSelect || !teacherSelect || !subjectSelect.value) return;

            teacherSelect.innerHTML = '<option value="">Select a teacher</option>';

            fetch(`/get_subject_teachers/${subjectSelect.value}?is_substitute=${isSubstitute}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.text = teacher.username;
                        teacherSelect.add(option);
                    });
                });
        }

        function updateTeacherListForYearGroup() {
            const subjectSelect = document.querySelector('#editByYearGroup select[name="subject_id"], #timetableForm select[name="subject_id"]');
            const isSubstituteCheckbox = document.getElementById('year_group_is_substitute');
            const isSubstitute = isSubstituteCheckbox ? isSubstituteCheckbox.checked : false;
            const teacherSelect = document.getElementById('year_group_teacher_select');

            if (!subjectSelect || !teacherSelect || !subjectSelect.value) return;

            teacherSelect.innerHTML = '<option value="">Select a teacher</option>';

            fetch(`/get_subject_teachers/${subjectSelect.value}?is_substitute=${isSubstitute}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.text = teacher.username;
                        teacherSelect.add(option);
                    });
                });
        }

        // Add event listeners when the document loads
        document.addEventListener('DOMContentLoaded', function() {
            const subjectTeacherSelect = document.getElementById('subject_teacher_select');
            const yearGroupTeacherSelect = document.getElementById('year_group_teacher_select');
            
            if (subjectTeacherSelect) {
                updateTeacherListForSubject();
            }
            if (yearGroupTeacherSelect) {
                updateTeacherListForYearGroup();
            }
            
            // Add change event listeners for subject dropdowns
            const subjectSelects = document.querySelectorAll('select[name="subject_id"]');
            subjectSelects.forEach(select => {
                select.addEventListener('change', function() {
                    const form = this.closest('form');
                    if (form.querySelector('#subject_teacher_select')) {
                        updateTeacherListForSubject();
                    } else if (form.querySelector('#year_group_teacher_select')) {
                        updateTeacherListForYearGroup();
                    }
                });
            });
        });

        // Add to the existing script section
        function showFreeDayEditForm(entryId, description, date) {
            document.getElementById('edit_free_day_id').value = entryId;
            document.getElementById('edit_free_day_date').value = date;
            document.getElementById('edit_free_day_message').value = description;
            document.getElementById('editFreeDayModal').style.display = 'block';
        }

        function closeFreeDayEditModal() {
            document.getElementById('editFreeDayModal').style.display = 'none';
        }

        // Update the window onclick handler to include the new modal
        window.onclick = function(event) {
            if (event.target == document.getElementById('freeDayModal')) {
                closeFreeDayModal();
            } else if (event.target == document.getElementById('editFreeDayModal')) {
                closeFreeDayEditModal();
            } else if (event.target == document.getElementById('noteModal')) {
                closeNoteModal();
            }
        }

        function showAddNote(entryId) {
            document.getElementById('noteModalTitle').textContent = 'Add Note';
            document.getElementById('note_entry_id').value = entryId;
            document.getElementById('noteContent').value = '';
            document.getElementById('noteModal').style.display = 'block';
        }

        function showEditNote(entryId) {
            document.getElementById('noteModalTitle').textContent = 'Edit Note';
            document.getElementById('note_entry_id').value = entryId;
            
            fetch(`/get_note/${entryId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('noteContent').value = data.content;
                    document.getElementById('noteModal').style.display = 'block';
                });
        }

        function saveNote(event) {
            event.preventDefault();
            const entryId = document.getElementById('note_entry_id').value;
            const content = document.getElementById('noteContent').value;
            
            if (!content.trim()) {
                alert('Please enter a note before saving.');
                return;
            }

            fetch('/add_note', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    entry_id: entryId,
                    content: content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeNoteModal();
                    location.reload();
                } else {
                    alert('Error saving note: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving note. Please try again.');
            });
        }

        function closeNoteModal() {
            document.getElementById('noteModal').style.display = 'none';
        }

        // Update the function for initializing teacher lists
        document.addEventListener('DOMContentLoaded', function() {
            const subjectTeacherSelect = document.getElementById('subject_teacher_select');
            const yearGroupTeacherSelect = document.getElementById('year_group_teacher_select');
            const regularTeacherSelect = document.getElementById('teacher_select');
            
            // Add event listeners for subject dropdowns
            const subjectSelects = document.querySelectorAll('select[name="subject_id"]');
            subjectSelects.forEach(select => {
                select.addEventListener('change', function() {
                    const form = this.closest('form');
                    if (form.querySelector('#subject_teacher_select')) {
                        updateTeacherListForSubject();
                    } else if (form.querySelector('#year_group_teacher_select')) {
                        updateTeacherListForYearGroup();
                    } else if (form.querySelector('#teacher_select')) {
                        updateTeacherList();
                    }
                });

                // Trigger initial update for each subject select
                if (select.closest('form').querySelector('#subject_teacher_select')) {
                    updateTeacherListForSubject();
                } else if (select.closest('form').querySelector('#year_group_teacher_select')) {
                    updateTeacherListForYearGroup();
                } else if (select.closest('form').querySelector('#teacher_select')) {
                    updateTeacherList();
                }
            });
        });

        // Update the updateTeacherList function to handle null values
        function updateTeacherList() {
            const subjectSelect = document.getElementById('subject_select');
            const isSubstitute = document.getElementById('is_substitute')?.checked || false;
            const teacherSelect = document.getElementById('teacher_select');

            if (!subjectSelect || !teacherSelect) return;

            // Clear current options
            teacherSelect.innerHTML = '<option value="">Select a teacher</option>';

            // Get teachers based on subject and substitute status
            fetch(`/get_subject_teachers/${subjectSelect.value}?is_substitute=${isSubstitute}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.text = teacher.username;
                        teacherSelect.add(option);
                    });
                });
        }

        // Similar updates for other teacher list functions
        function updateTeacherListForSubject() {
            const subjectSelect = document.querySelector('select[name="subject_id"]');
            const isSubstitute = document.getElementById('subject_is_substitute')?.checked || false;
            const teacherSelect = document.getElementById('subject_teacher_select');

            if (!subjectSelect || !teacherSelect) return;

            teacherSelect.innerHTML = '<option value="">Select a teacher</option>';

            fetch(`/get_subject_teachers/${subjectSelect.value}?is_substitute=${isSubstitute}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.text = teacher.username;
                        teacherSelect.add(option);
                    });
                });
        }

        function updateTeacherListForYearGroup() {
            const subjectSelect = document.querySelector('select[name="subject_id"]');
            const isSubstitute = document.getElementById('year_group_is_substitute')?.checked || false;
            const teacherSelect = document.getElementById('year_group_teacher_select');

            if (!subjectSelect || !teacherSelect) return;

            teacherSelect.innerHTML = '<option value="">Select a teacher</option>';

            fetch(`/get_subject_teachers/${subjectSelect.value}?is_substitute=${isSubstitute}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.text = teacher.username;
                        teacherSelect.add(option);
                    });
                });
        }

        // Update the initialization code 
        document.addEventListener('DOMContentLoaded', function() {
            const subjectSelects = document.querySelectorAll('select[name="subject_id"]');
            
            subjectSelects.forEach(select => {
                // First trigger the change event on load
                const changeEvent = new Event('change');
                select.dispatchEvent(changeEvent);
                
                // Add change event listener
                select.addEventListener('change', function() {
                    const form = this.closest('form');
                    if (form.querySelector('#subject_teacher_select')) {
                        updateTeacherListForSubject();
                    } else if (form.querySelector('#year_group_teacher_select')) {
                        updateTeacherListForYearGroup();
                    } else if (form.querySelector('#teacher_select')) {
                        updateTeacherList();
                    }
                });
            });
        });

        // Update all teacher list functions to handle the initial load better
        function updateTeacherList() {
            const subjectSelect = document.getElementById('subject_select');
            const isSubstituteCheckbox = document.getElementById('is_substitute');
            const isSubstitute = isSubstituteCheckbox ? isSubstituteCheckbox.checked : false;
            const teacherSelect = document.getElementById('teacher_select');

            if (!subjectSelect || !teacherSelect || !subjectSelect.value) return;

            teacherSelect.innerHTML = '<option value="">Select a teacher</option>';

            fetch(`/get_subject_teachers/${subjectSelect.value}?is_substitute=${isSubstitute}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.text = teacher.username;
                        teacherSelect.add(option);
                    });
                });
        }

        function updateTeacherListForSubject() {
            const subjectSelect = document.querySelector('select[name="subject_id"]');
            const isSubstituteCheckbox = document.getElementById('subject_is_substitute');
            const isSubstitute = isSubstituteCheckbox ? isSubstituteCheckbox.checked : false;
            const teacherSelect = document.getElementById('subject_teacher_select');

            if (!subjectSelect || !teacherSelect || !subjectSelect.value) return;

            teacherSelect.innerHTML = '<option value="">Select a teacher</option>';

            fetch(`/get_subject_teachers/${subjectSelect.value}?is_substitute=${isSubstitute}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.text = teacher.username;
                        teacherSelect.add(option);
                    });
                });
        }

        function updateTeacherListForYearGroup() {
            const subjectSelect = document.querySelector('select[name="subject_id"]');
            const isSubstituteCheckbox = document.getElementById('year_group_is_substitute');
            const isSubstitute = isSubstituteCheckbox ? isSubstituteCheckbox.checked : false;
            const teacherSelect = document.getElementById('year_group_teacher_select');

            if (!subjectSelect || !teacherSelect || !subjectSelect.value) return;

            teacherSelect.innerHTML = '<option value="">Select a teacher</option>';

            fetch(`/get_subject_teachers/${subjectSelect.value}?is_substitute=${isSubstitute}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.text = teacher.username;
                        teacherSelect.add(option);
                    });
                });
        }

        // Update these functions in the script section
        function updateTeacherListForSubject() {
            const subjectSelect = document.querySelector('#timetableForm select[name="subject_id"]');
            const isSubstituteCheckbox = document.getElementById('subject_is_substitute');
            const isSubstitute = isSubstituteCheckbox ? isSubstituteCheckbox.checked : false;
            const teacherSelect = document.getElementById('subject_teacher_select');

            if (!subjectSelect || !teacherSelect) return;

            teacherSelect.innerHTML = '<option value="">Select a teacher</option>';

            // Get teachers based on selected subject
            fetch(`/get_subject_teachers/${subjectSelect.value}?is_substitute=${isSubstitute}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.text = teacher.username;
                        teacherSelect.add(option);
                    });
                });
        }

        function updateTeacherListForYearGroup() {
            const subjectSelect = document.querySelector('#timetableForm select[name="subject_id"]');
            const isSubstituteCheckbox = document.getElementById('year_group_is_substitute');
            const isSubstitute = isSubstituteCheckbox ? isSubstituteCheckbox.checked : false;
            const teacherSelect = document.getElementById('year_group_teacher_select');

            if (!subjectSelect || !teacherSelect) return;

            teacherSelect.innerHTML = '<option value="">Select a teacher</option>';

            // Get teachers based on selected subject
            fetch(`/get_subject_teachers/${subjectSelect.value}?is_substitute=${isSubstitute}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.text = teacher.username;
                        teacherSelect.add(option);
                    });
                });
        }

        // Update the initialization code
        document.addEventListener('DOMContentLoaded', function() {
            // Initial update for all forms
            if (document.getElementById('subject_teacher_select')) {
                // For Edit by Subject
                const subjectSelect = document.querySelector('#timetableForm select[name="subject_id"]');
                if (subjectSelect) {
                    updateTeacherListForSubject();
                    subjectSelect.addEventListener('change', updateTeacherListForSubject);
                }
            }
            
            if (document.getElementById('year_group_teacher_select')) {
                // For Edit by Year Group
                const subjectSelect = document.querySelector('#timetableForm select[name="subject_id"]');
                if (subjectSelect) {
                    updateTeacherListForYearGroup();
                    subjectSelect.addEventListener('change', updateTeacherListForYearGroup);
                }
            }
            
            if (document.getElementById('teacher_select')) {
                // For Edit by User
                const subjectSelect = document.getElementById('subject_select');
                if (subjectSelect) {
                    updateTeacherList();
                    subjectSelect.addEventListener('change', updateTeacherList);
                }
            }

            // Add change event listeners for substitute checkboxes
            const substituteCheckboxes = document.querySelectorAll('input[type="checkbox"][name="is_substitute"]');
            substituteCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const form = this.closest('form');
                    if (form.querySelector('#subject_teacher_select')) {
                        updateTeacherListForSubject();
                    } else if (form.querySelector('#year_group_teacher_select')) {
                        updateTeacherListForYearGroup();
                    } else if (form.querySelector('#teacher_select')) {
                        updateTeacherList();
                    }
                });
            });
        });

        // Update the initialization code
        document.addEventListener('DOMContentLoaded', function() {
            // For Edit by User - works correctly
            if (document.getElementById('subject_select')) {
                updateTeacherList();
            }
            
            // Add similar initialization for Subject and Year Group
            if (document.getElementById('subject_teacher_select')) {
                const subjectSelect = document.querySelector('#timetableForm select[name="subject_id"]');
                if (subjectSelect && subjectSelect.value) {
                    updateTeacherListForSubject();
                }
            }
            
            if (document.getElementById('year_group_teacher_select')) {
                const subjectSelect = document.querySelector('#timetableForm select[name="subject_id"]');
                if (subjectSelect && subjectSelect.value) {
                    updateTeacherListForYearGroup();
                }
            }

            // Add change event listeners
            const subjectSelects = document.querySelectorAll('select[name="subject_id"]');
            subjectSelects.forEach(select => {
                select.addEventListener('change', function() {
                    const form = this.closest('form');
                    if (form.querySelector('#subject_teacher_select')) {
                        updateTeacherListForSubject();
                    } else if (form.querySelector('#year_group_teacher_select')) {
                        updateTeacherListForYearGroup();
                    } else if (form.querySelector('#teacher_select')) {
                        updateTeacherList();
                    }
                });
            });
        });

        // Update the teacher list functions
        function updateTeacherListForSubject() {
            const subjectSelect = document.querySelector('#timetableForm select[name="subject_id"]');
            const isSubstituteCheckbox = document.getElementById('subject_is_substitute');
            const isSubstitute = isSubstituteCheckbox ? isSubstituteCheckbox.checked : false;
            const teacherSelect = document.getElementById('subject_teacher_select');

            if (!subjectSelect || !teacherSelect) return;

            // Clear current options
            teacherSelect.innerHTML = '<option value="">Select a teacher</option>';

            // Get teachers for selected subject
            fetch(`/get_subject_teachers/${subjectSelect.value}?is_substitute=${isSubstitute}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.text = teacher.username;
                        teacherSelect.add(option);
                    });
                });
        }

        function updateTeacherListForYearGroup() {
            const subjectSelect = document.querySelector('#timetableForm select[name="subject_id"]');
            const isSubstituteCheckbox = document.getElementById('year_group_is_substitute');
            const isSubstitute = isSubstituteCheckbox ? isSubstituteCheckbox.checked : false;
            const teacherSelect = document.getElementById('year_group_teacher_select');

            if (!subjectSelect || !teacherSelect) return;

            // Clear current options
            teacherSelect.innerHTML = '<option value="">Select a teacher</option>';

            // Get teachers for selected subject
            fetch(`/get_subject_teachers/${subjectSelect.value}?is_substitute=${isSubstitute}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.text = teacher.username;
                        teacherSelect.add(option);
                    });
                });
        }

        // Update the initialization code
        document.addEventListener('DOMContentLoaded', function() {
            // Initial updates for each form type if it exists
            const bySubjectForm = document.getElementById('timetableForm');
            if (bySubjectForm) {
                const subjectSelect = bySubjectForm.querySelector('select[name="subject_id"]');
                const teacherSelect = document.getElementById('subject_teacher_select');
                const yearGroupTeacherSelect = document.getElementById('year_group_teacher_select');
                
                if (subjectSelect && subjectSelect.value) {
                    // For Edit by Subject
                    if (teacherSelect) {
                        updateTeacherListForSubject();
                    }
                    // For Edit by Year Group
                    if (yearGroupTeacherSelect) {
                        updateTeacherListForYearGroup();
                    }
                }

                // Add change event listeners
                subjectSelect?.addEventListener('change', function() {
                    if (teacherSelect) {
                        updateTeacherListForSubject();
                    } else if (yearGroupTeacherSelect) {
                        updateTeacherListForYearGroup();
                    }
                });
            }

            // Add event listeners for substitute checkboxes
            const substituteCheckboxes = document.querySelectorAll('input[type="checkbox"][name="is_substitute"]');
            substituteCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const form = this.closest('form');
                    if (form.querySelector('#subject_teacher_select')) {
                        updateTeacherListForSubject();
                    } else if (form.querySelector('#year_group_teacher_select')) {
                        updateTeacherListForYearGroup();
                    }
                });
            });
        });

        // Update the initialization code in the script section
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize teacher lists for all forms that exist
            if (document.getElementById('subject_select')) {
                // For Edit by User form
                const subjectSelect = document.getElementById('subject_select');
                if (subjectSelect.value) {
                    updateTeacherList();
                }
            }

            // For Edit by Subject form
            if (document.getElementById('subject_teacher_select')) {
                const subjectSelect = document.querySelector('#timetableForm select[name="subject_id"]');
                if (subjectSelect && subjectSelect.value) {
                    updateTeacherListForSubject();
                }
            }

            // For Edit by Year Group form
            if (document.getElementById('year_group_teacher_select')) {
                const subjectSelect = document.querySelector('#timetableForm select[name="subject_id"]');
                if (subjectSelect && subjectSelect.value) {
                    updateTeacherListForYearGroup();
                }
            }

            // Add change event listeners for subject dropdowns
            const subjectSelects = document.querySelectorAll('select[name="subject_id"]');
            subjectSelects.forEach(select => {
                // Trigger update when subject changes
                select.addEventListener('change', function() {
                    const form = this.closest('form');
                    if (form.querySelector('#subject_teacher_select')) {
                        updateTeacherListForSubject();
                    } else if (form.querySelector('#year_group_teacher_select')) {
                        updateTeacherListForYearGroup();
                    } else if (form.querySelector('#teacher_select')) {
                        updateTeacherList();
                    }
                });
            });

            // Add change event listeners for substitute checkboxes
            const substituteCheckboxes = document.querySelectorAll('input[type="checkbox"][name="is_substitute"]');
            substituteCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const form = this.closest('form');
                    if (form.querySelector('#subject_teacher_select')) {
                        updateTeacherListForSubject();
                    } else if (form.querySelector('#year_group_teacher_select')) {
                        updateTeacherListForYearGroup();
                    } else if (form.querySelector('#teacher_select')) {
                        updateTeacherList();
                    }
                });
            });
        });

        // Update the initialization code
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize teacher lists for subject and year group forms
            if (document.querySelector('#timetableForm')) {
                const subjectSelect = document.querySelector('#timetableForm select[name="subject_id"]');
                const teacherSelect = document.getElementById('subject_teacher_select');
                const yearGroupTeacherSelect = document.getElementById('year_group_teacher_select');

                if (subjectSelect && subjectSelect.value) {
                    if (teacherSelect) {
                        // For Edit by Subject form
                        fetch(`/get_subject_teachers/${subjectSelect.value}?is_substitute=false`)
                            .then(response => response.json())
                            .then(data => {
                                teacherSelect.innerHTML = '<option value="">Select a teacher</option>';
                                data.forEach(teacher => {
                                    const option = document.createElement('option');
                                    option.value = teacher.id;
                                    option.text = teacher.username;
                                    teacherSelect.add(option);
                                });
                            });
                    } else if (yearGroupTeacherSelect) {
                        // For Edit by Year Group form
                        fetch(`/get_subject_teachers/${subjectSelect.value}?is_substitute=false`)
                            .then(response => response.json())
                            .then(data => {
                                yearGroupTeacherSelect.innerHTML = '<option value="">Select a teacher</option>';
                                data.forEach(teacher => {
                                    const option = document.createElement('option');
                                    option.value = teacher.id;
                                    option.text = teacher.username;
                                    yearGroupTeacherSelect.add(option);
                                });
                            });
                    }
                }

                // Add change event listeners
                if (subjectSelect) {
                    subjectSelect.addEventListener('change', function() {
                        if (teacherSelect) {
                            updateTeacherListForSubject();
                        } else if (yearGroupTeacherSelect) {
                            updateTeacherListForYearGroup();
                        }
                    });
                }
            }
        });
    </script>
    <style>
    .mode-buttons {
        margin: 20px 0;
    }

    .mode-buttons button {
        margin-right: 10px;
        padding: 8px 16px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .mode-buttons button:hover {
        background-color: #0056b3;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }

    table th, table td {
        padding: 8px;
        text-align: left;
        border: 1px solid #ddd;
    }

    table th {
        background-color: #f8f9fa;
    }

    table tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    table tr:hover {
        background-color: #f2f2f2;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 60%;
        max-width: 600px;
        border-radius: 5px;
        position: relative;
    }

    .search-container {
        margin-bottom: 15px;
    }

    .search-container input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .assignees-container {
        display: flex;
        gap: 20px;
        max-height: 400px;
        overflow-y: auto;
    }

    .checkbox-list {
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 4px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        padding: 5px 0;
    }

    .checkbox-item input[type="checkbox"] {
        margin-right: 8px;
    }

    .modal-footer {
        margin-top: 15px;
        text-align: right;
    }

    .modal-footer button {
        margin-left: 10px;
    }

    .modal-footer button.danger {
        background-color: #dc3545;
        color: white;
    }

    .modal-footer button.danger:hover {
        background-color: #c82333;
    }

    #assignedUsersList {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
    }

    #assignedUsersList li {
        padding: 4px 0;
        border-bottom: 1px solid #eee;
    }

    #assignedUsersList li:last-child {
        border-bottom: none;
    }

    /* Add to existing style section */
    #edit_free_day_message {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: vertical;
        min-height: 100px;
    }

    .free-day-entry {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        border: 1px dashed #ccc;
        margin: 5px 0;
    }

    .free-day-entry strong {
        color: #dc3545;
        font-size: 1.1em;
    }

    .free-day-entry .description {
        font-style: italic;
        color: #666;
        margin: 5px 0;
    }

    #noteContent {
        width: 100%;
        margin: 10px 0;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: vertical;
        min-height: 100px;
    }

    .note-button {
        background-color: #28a745;
        color: white;
        margin-left: 5px;
    }

    .note-button:hover {
        background-color: #218838;
    }

    #free_day_message {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: vertical;
    }

    .free-day-entry {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        border: 1px dashed #ccc;
        margin: 5px 0;
        text-align: center;
    }

    .free-day-entry .message {
        font-style: italic;
        color: #666;
    }
    </style>
</head>
<body>
    <h2>Admin - Manage Timetables</h2>
    
    <!-- Mode Selection Buttons -->
    <div class="mode-buttons">
        <button type="button" onclick="showEditByUser()">Edit by User</button>
        <button type="button" onclick="showEditBySubject()">Edit by Subject</button>
        <button type="button" onclick="showEditByYearGroup()">Edit by Year Group</button>
    </div>

    <!-- Edit by User Section -->
    <div id="editByUser" style="display: none;">
        <h3>Edit by User</h3>
        <input type="text" id="searchUser" placeholder="Search users...">
        <table border="1">
            <tr>
                <th>Username</th>
                <th>Role</th>
                <th>Year Group</th>
                <th>Subjects</th>
                <th>Edit Timetables</th>
            </tr>
            {% for user in users %}
                <tr>
                    <td>{{ user.username }}</td>
                    <td>{{ user.role }}</td>
                    <td>{{ user.year_group if user.year_group else "N/A" }}</td>
                    <td>
                        <button type="button" onclick="showSubjects({{ user.id }})">View Subjects</button>
                    </td>
                    <td>
                        <button type="button" onclick="showUserTimetable({{ user.id }})">Edit Timetables</button>
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>

    <!-- Edit by Subject Section -->
    <div id="editBySubject" style="display: none;">
        <h3>Edit by Subject</h3>
        <input type="text" id="searchSubject" placeholder="Search subjects...">
        <table border="1">
            <tr>
                <th>Subject</th>
                <th>Type</th>
                <th>Teachers</th>
                <th>Students</th>
                <th>Edit Timetables</th>
            </tr>
            {% for subject in subjects %}
                <tr>
                    <td>{{ subject.name }}</td>
                    <td>Subject</td>
                    <td>{{ subject.assigned_users|selectattr('user.role', 'equalto', 'staff')|map(attribute='user.username')|join(', ') }}</td>
                    <td>
                        <button type="button" onclick="showStudents({{ subject.id }})">View Students</button>
                    </td>
                    <td>
                        <button type="button" onclick="showSubjectTimetable({{ subject.id }})">Edit Timetables</button>
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>

    <!-- Edit by Year Group Section -->
    <div id="editByYearGroup" style="display: none;">
        <h3>Edit by Year Group</h3>
        <input type="text" id="searchYearGroup" placeholder="Search year groups...">
        <table border="1">
            <tr>
                <th>Year Group</th>
                <th>Students</th>
                <th>Edit Timetables</th>
            </tr>
            {% for year_group in year_groups %}
                <tr>
                    <td>{{ year_group }}</td>
                    <td>
                        <button type="button" onclick="showYearGroupStudents('{{ year_group }}')">View Students</button>
                    </td>
                    <td>
                        <button type="button" onclick="showYearGroupTimetable('{{ year_group }}')">Edit Timetables</button>
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>

    <!-- Subjects Menu -->
    <div id="subjectsMenu" style="display: none;">
        <h3>Assigned Subjects</h3>
        <ul id="subjectsList"></ul>
        <button type="button" onclick="document.getElementById('subjectsMenu').style.display='none'">Close</button>
    </div>

    <!-- Students Menu -->
    <div id="studentsMenu" style="display: none;">
        <h3>Assigned Students</h3>
        <ul id="studentsList"></ul>
        <button type="button" onclick="document.getElementById('studentsMenu').style.display='none'">Close</button>
    </div>

    {% if selected_user or selected_subject or selected_year_group %}
        <h3>
            Managing timetable for 
            {% if selected_subject %}
                {{ selected_subject.name }} assignees
            {% elif selected_year_group %}
                Year Group {{ selected_year_group }}
            {% else %}
                {{ selected_user.username }}
            {% endif %}
        </h3>

        <!-- Week Navigation -->
        <h3>
            Week: {{ week_range }}
            <button type="button" onclick="changeWeek(-1)">← Previous</button>
            <button type="button" onclick="changeWeek(1)">Next →</button>
        </h3>

        <!-- Step 2: Add Timetable Entry -->
        {% if selected_user %}
            <h3>Add Timetable Entry</h3>
            <form method="post">
                <input type="hidden" name="action" value="add_entry">
                <input type="hidden" name="user_id" value="{{ selected_user.id }}">

                Date: <input type="date" name="date" required><br>
                Start Time: <input type="time" name="start_time" required><br>
                End Time: <input type="time" name="end_time" required><br>

                Select Subject:
                <select name="subject_id" id="subject_select" required onchange="updateTeacherList()">
                    {% for assignment in assigned_subjects %}
                        <option value="{{ assignment.subject.id }}">{{ assignment.subject.name }}</option>
                    {% endfor %}
                </select><br>

                <div class="teacher-selection">
                    Select Teacher:
                    <select name="teacher_id" id="teacher_select" required>
                        <option value="">Select a teacher</option>
                    </select>
                    <input type="checkbox" id="is_substitute" name="is_substitute" onchange="updateTeacherList()">
                    <label for="is_substitute">Is substitute?</label>
                </div><br>

                Select Room:
                <select name="room_id" required>
                    {% for room in rooms %}
                        <option value="{{ room.id }}">{{ room.name }}</option>
                    {% endfor %}
                </select><br>

                <button type="submit">Add Entry</button>
            </form>

            <script>
            function updateTeacherList() {
                const subjectSelect = document.getElementById('subject_select');
                const isSubstitute = document.getElementById('is_substitute').checked;
                const teacherSelect = document.getElementById('teacher_select');

                // Clear current options
                teacherSelect.innerHTML = '<option value="">Select a teacher</option>';

                // Get teachers based on subject and substitute status
                fetch(`/get_subject_teachers/${subjectSelect.value}?is_substitute=${isSubstitute}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(teacher => {
                            const option = document.createElement('option');
                            option.value = teacher.id;
                            option.text = teacher.username;
                            teacherSelect.add(option);
                        });
                    });
            }

            // Initialize teacher list when page loads
            document.addEventListener('DOMContentLoaded', updateTeacherList);
            </script>
        {% endif %}

        <!-- Mass Timetable Entry for Subject Assignees -->
        {% if selected_subject %}
            <form id="timetableForm" method="post">
                <input type="hidden" name="action" value="assign_by_subject">
                <input type="hidden" name="original_subject_id" value="{{ selected_subject.id }}">

                Date: <input type="date" name="date" required><br>
                Start Time: <input type="time" name="start_time" required><br>
                End Time: <input type="time" name="end_time" required><br>

                Select Subject:
                <select name="subject_id" required onchange="updateTeacherListForSubject()">
                    {% for subject in subjects %}
                        <option value="{{ subject.id }}" {% if subject.id == selected_subject.id %}selected{% endif %}>
                            {{ subject.name }}
                        </option>
                    {% endfor %}
                </select><br>

                <div class="teacher-selection">
                    Select Teacher:
                    <select name="teacher_id" id="subject_teacher_select" required>
                        <option value="">Select a teacher</option>
                    </select>
                    <input type="checkbox" id="subject_is_substitute" name="is_substitute" onchange="updateTeacherListForSubject()">
                    <label for="subject_is_substitute">Is substitute?</label>
                </div><br>

                Select Room:
                <select name="room_id" required>
                    {% for room in rooms %}
                        <option value="{{ room.id }}">{{ room.name }}</option>
                    {% endfor %}
                </select><br>

                <button type="submit">Add Entry</button>
            </form>
        {% endif %}

        <!-- Mass Timetable Entry for Year Group Assignees -->
        {% if selected_year_group %}
            <form id="timetableForm" method="post">
                <input type="hidden" name="action" value="assign_by_year_group">
                <input type="hidden" name="year_group" value="{{ selected_year_group }}">

                Date: <input type="date" name="date" required><br>
                Start Time: <input type="time" name="start_time" required><br>
                End Time: <input type="time" name="end_time" required><br>

                Select Subject:
                <select name="subject_id" required onchange="updateTeacherListForYearGroup()">
                    {% for subject in subjects %}
                        <option value="{{ subject.id }}">{{ subject.name }}</option>
                    {% endfor %}
                </select><br>

                <div class="teacher-selection">
                    Select Teacher:
                    <select name="teacher_id" id="year_group_teacher_select" required>
                        <option value="">Select a teacher</option>
                    </select>
                    <input type="checkbox" id="year_group_is_substitute" name="is_substitute" onchange="updateTeacherListForYearGroup()">
                    <label for="year_group_is_substitute">Is substitute?</label>
                </div><br>

                Select Room:
                <select name="room_id" required>
                    {% for room in rooms %}
                        <option value="{{ room.id }}">{{ room.name }}</option>
                    {% endfor %}
                </select><br>

                <button type="submit">Add Entry</button>
            </form>
        {% endif %}
    {% endif %}

    <!-- Step 3: Display Current Week's Timetable -->
    <h3>Timetable for {{ week_range }}</h3>
    {% if timetable %}
        <table border="1">
            <tr>
                {% for day in ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"] %}
                    <th>{{ day }} - {{ (week_start + timedelta(days=loop.index0)).strftime('%d/%m') }}</th>
                {% endfor %}
            </tr>
            <tr>
                {% for day in ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"] %}
                    <td>
                        <ul>
                            {% for entry in timetable if entry.date.strftime('%A') == day %}
                                <li>
                                    {% if entry.is_free_day %}
                                        <div class="free-day-entry">
                                            <strong>Free Day</strong><br>
                                            {{ entry.start_time.strftime('%H:%M') }} - {{ entry.end_time.strftime('%H:%M') }}<br>
                                            <span class="description">Description: {{ entry.subject }}</span><br>
                                            
                                            <!-- Add Edit button -->
                                            <button type="button" onclick="showFreeDayEditForm('{{ entry.id }}', '{{ entry.subject }}', '{{ entry.date }}')">Edit</button>

                                            <!-- Delete button -->
                                            <button type="button" onclick="showDeleteConfirmation('{{ entry.id }}', event)">Delete</button>
                                            <hr>
                                        </div>
                                    {% else %}
                                        {{ entry.start_time.strftime('%H:%M') }} - {{ entry.end_time.strftime('%H:%M') }}<br>
                                        <strong>{{ entry.subject }}</strong><br>
                                        {{ entry.teacher }}{% if entry.is_substitute %} (Substitute){% endif %}<br>
                                        Room: {{ entry.room if entry.room else "Not assigned" }}<br>
                                        
                                        <!-- Add Edit button -->
                                        <button type="button" onclick="showEditForm('{{ entry.id }}')">Edit</button>

                                        {% if selected_user %}
                                            <!-- Only show Delete for User in Edit by User mode -->
                                            <form method="post" style="display:inline;">
                                                <input type="hidden" name="action" value="delete_entry_for_user">
                                                <input type="hidden" name="entry_id" value="{{ entry.id }}">
                                                <input type="hidden" name="user_id" value="{{ selected_user.id }}">
                                                <button type="submit" onclick="return confirm('Remove this entry for {{ selected_user.username }}?')">
                                                    Delete for User
                                                </button>
                                            </form>
                                        {% endif %}

                                        <!-- Delete for All button -->
                                        <button type="button" onclick="showDeleteConfirmation('{{ entry.id }}', event)">
                                            Delete for All
                                        </button>

                                        {% if entry.note %}
                                            <button type="button" onclick="showEditNote('{{ entry.id }}')">Edit Note</button>
                                        {% else %}
                                            <button type="button" onclick="showAddNote('{{ entry.id }}')">Add Note</button>
                                        {% endif %}
                                        <hr>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    </td>
                {% endfor %}
            </tr>
        </table>
    {% else %}
        <p>No timetable entries for this week.</p>
    {% endif %}

    <p><a href="{{ url_for('admin') }}">Back to Admin Panel</a></p>

    <!-- Edit Entry Modal -->
    <div id="editEntryModal" class="modal">
        <div class="modal-content">
            <h3>Edit Timetable Entry</h3>
            <form id="editEntryForm" method="post" action="{{ url_for('edit_entry') }}">
                <input type="hidden" name="action" value="edit_entry">
                <input type="hidden" name="entry_id" id="edit_entry_id">

                <div class="form-group">
                    <label for="edit_date">Date:</label>
                    <input type="date" name="date" id="edit_date" required>
                </div>

                <div class="form-group">
                    <label for="edit_start_time">Start Time:</label>
                    <input type="time" name="start_time" id="edit_start_time" required>
                </div>

                <div class="form-group">
                    <label for="edit_end_time">End Time:</label>
                    <input type="time" name="end_time" id="edit_end_time" required>
                </div>

                <div class="form-group">
                    <label for="edit_subject_id">Subject:</label>
                    <select name="subject_id" id="edit_subject_id" required onchange="updateEditTeacherList()">
                        {% for subject in subjects %}
                            <option value="{{ subject.id }}">{{ subject.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <input type="checkbox" id="edit_is_substitute" name="is_substitute" onchange="updateEditTeacherList()">
                    <label for="edit_is_substitute">Is substitute?</label><br>

                    <label for="edit_teacher_id">Teacher:</label>
                    <select name="teacher_id" id="edit_teacher_id" required>
                        {% for staff in staff_users %}
                            <option value="{{ staff.id }}">{{ staff.username }}</option>
                        {% endfor %}
                    </select>
                </div>

                <script>
                function updateEditTeacherList() {
                    const subjectSelect = document.getElementById('edit_subject_id');
                    const isSubstitute = document.getElementById('edit_is_substitute').checked;
                    const teacherSelect = document.getElementById('edit_teacher_id');

                    teacherSelect.innerHTML = '<option value="">Select a teacher</option>';

                    fetch(`/get_subject_teachers/${subjectSelect.value}?is_substitute=${isSubstitute}`)
                        .then(response => response.json())
                        .then(data => {
                            data.forEach(teacher => {
                                const option = document.createElement('option');
                                option.value = teacher.id;
                                option.text = teacher.username;
                                teacherSelect.add(option);
                            });
                        });
                }
                </script>

                <div class="form-group">
                    <label for="edit_room_id">Room:</label>
                    <select name="room_id" id="edit_room_id" required>
                        {% for room in rooms %}
                            <option value="{{ room.id }}">{{ room.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-actions">
                    <button type="button" onclick="manageAssignees()">Manage Assignees</button>
                    <button type="submit">Save Changes</button>
                    <button type="button" onclick="closeEditModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmationModal" class="modal">
        <div class="modal-content">
            <h3>Confirm Delete</h3>
            <p>This entry is assigned to the following users:</p>
            <ul id="assignedUsersList"></ul>
            <p>Are you sure you want to delete this entry for all users?</p>
            <form id="deleteConfirmForm" method="post">
                <input type="hidden" name="action" value="delete_entry_for_all">
                <input type="hidden" name="entry_id" id="delete_entry_id">
                <div class="modal-footer">
                    <button type="submit" class="danger">Delete for All</button>
                    <button type="button" onclick="closeDeleteModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manage Assignees Modal -->
    <div id="manageAssigneesModal" class="modal">
        <div class="modal-content">
            <h3>Manage Assignees</h3>
            <div class="search-container">
                <input type="text" id="assigneeSearch" placeholder="Search users..." onkeyup="filterUsers()">
            </div>
            <div class="assignees-container">
                <div id="currentAssignees">
                    <h4>Currently Assigned Users</h4>
                    <div id="assigneesList" class="checkbox-list"></div>
                </div>
                <div id="availableUsers">
                    <h4>Available Users</h4>
                    <div id="availableUsersList" class="checkbox-list"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="updateAssignees()">Save Changes</button>
                <button type="button" onclick="closeAssigneesModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add this modal form before the closing body tag -->
    <div id="freeDayModal" class="modal">
        <div class="modal-content">
            <h3>Set Free Day</h3>
            <form id="freeDayForm" method="post">
                <input type="hidden" name="action" value="set_free_day">
                
                <div class="form-group">
                    <label for="free_day_date">Date:</label>
                    <input type="date" name="date" id="free_day_date" required>
                </div>

                <div class="form-group">
                    <label for="free_day_message">Message:</label>
                    <textarea name="message" id="free_day_message" rows="3" required 
                        placeholder="e.g., Public Holiday, Staff Development Day, etc."></textarea>
                </div>

                <div class="form-group">
                    <label for="free_day_scope">Apply to:</label>
                    <select name="scope" id="free_day_scope" required>
                        {% if selected_user %}
                            <option value="user">Selected User Only</option>
                        {% endif %}
                        {% if selected_subject %}
                            <option value="subject">All Users in Selected Subject</option>
                        {% endif %}
                        {% if selected_year_group %}
                            <option value="year_group">All Users in Selected Year Group</option>
                        {% endif %}
                        <option value="all">All Users</option>
                    </select>
                </div>

                <div class="modal-footer">
                    <button type="submit">Set Free Day</button>
                    <button type="button" onclick="closeFreeDayModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add this JavaScript -->
    <script>
    function showFreeDayForm() {
        document.getElementById('freeDayModal').style.display = 'block';
    }

    function closeFreeDayModal() {
        document.getElementById('freeDayModal').style.display = 'none';
    }

    // Close modal if clicking outside
    window.onclick = function(event) {
        if (event.target == document.getElementById('freeDayModal')) {
            closeFreeDayModal();
        }
    }
    </script>

    <!-- Add Free Day Edit Modal -->
    <div id="editFreeDayModal" class="modal">
        <div class="modal-content">
            <h3>Edit Free Day</h3>
            <form id="editFreeDayForm" method="post">
                <input type="hidden" name="action" value="edit_free_day">
                <input type="hidden" name="entry_id" id="edit_free_day_id">
                
                <div class="form-group">
                    <label for="edit_free_day_date">Date:</label>
                    <input type="date" name="date" id="edit_free_day_date" required>
                </div>

                <div class="form-group">
                    <label for="edit_free_day_message">Description:</label>
                    <textarea name="message" id="edit_free_day_message" rows="3" required></textarea>
                </div>

                <div class="modal-footer">
                    <button type="submit">Save Changes</button>
                    <button type="button" onclick="closeFreeDayEditModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Note Modal -->
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <h3 id="noteModalTitle">Add Note</h3>
            <form id="noteForm" onsubmit="saveNote(event)">
                <input type="hidden" id="note_entry_id">
                <textarea id="noteContent" rows="4" cols="50"></textarea>
                <div class="modal-footer">
                    <button type="submit">Save Note</button>
                    <button type="button" onclick="closeNoteModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
