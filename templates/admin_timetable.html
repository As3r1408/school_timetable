<!DOCTYPE html>
<html lang="en">
<head>
    <title>Admin - Manage Timetables</title>
    <script>
        function changeWeek(offset) {
            let form = document.createElement("form");
            form.method = "POST";
            form.style.display = "none";

            let input = document.createElement("input");
            input.type = "hidden";
            input.name = "week_change";
            input.value = offset;

            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }

        function showEditByUser() {
            document.getElementById("editByUser").style.display = "block";
            document.getElementById("editBySubject").style.display = "none";
            document.getElementById("editByYearGroup").style.display = "none";
        }

        function showEditBySubject() {
            document.getElementById("editByUser").style.display = "none";
            document.getElementById("editBySubject").style.display = "block";
            document.getElementById("editByYearGroup").style.display = "none";
        }

        function showEditByYearGroup() {
            document.getElementById("editByUser").style.display = "none";
            document.getElementById("editBySubject").style.display = "none";
            document.getElementById("editByYearGroup").style.display = "block";
        }

        function showUserTimetable(userId) {
            let form = document.createElement("form");
            form.method = "POST";
            form.style.display = "none";

            let input = document.createElement("input");
            input.type = "hidden";
            input.name = "user_id";
            input.value = userId;

            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }

        function showSubjectTimetable(subjectId) {
            let form = document.createElement("form");
            form.method = "POST";
            form.style.display = "none";

            let input = document.createElement("input");
            input.type = "hidden";
            input.name = "subject_id";
            input.value = subjectId;

            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }

        function showYearGroupTimetable(yearGroup) {
            let form = document.createElement("form");
            form.method = "POST";
            form.style.display = "none";

            let input = document.createElement("input");
            input.type = "hidden";
            input.name = "year_group";
            input.value = yearGroup;

            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }

        function showSubjects(userId) {
            fetch(`/get_assigned_subjects/${userId}`)
                .then(response => response.json())
                .then(data => {
                    let subjectsList = document.getElementById("subjectsList");
                    subjectsList.innerHTML = "";
                    data.forEach(subject => {
                        let li = document.createElement("li");
                        li.textContent = subject.name;
                        subjectsList.appendChild(li);
                    });
                    document.getElementById("subjectsMenu").style.display = "block";
                });
        }

        function showStudents(subjectId) {
            fetch(`/get_assigned_users/${subjectId}`)
                .then(response => response.json())
                .then(data => {
                    let studentsList = document.getElementById("studentsList");
                    studentsList.innerHTML = "";
                    data.forEach(user => {
                        let li = document.createElement("li");
                        li.textContent = user.username;
                        studentsList.appendChild(li);
                    });
                    document.getElementById("studentsMenu").style.display = "block";
                });
        }

        function showYearGroupStudents(yearGroup) {
            fetch(`/get_students_by_year_group/${yearGroup}`)
                .then(response => response.json())
                .then(data => {
                    let studentsList = document.getElementById("studentsList");
                    studentsList.innerHTML = "";
                    data.forEach(user => {
                        let li = document.createElement("li");
                        li.textContent = user.username;
                        studentsList.appendChild(li);
                    });
                    document.getElementById("studentsMenu").style.display = "block";
                });
        }
    </script>
</head>
<body>
    <h2>Admin - Manage Timetables</h2>

    <!-- Initial Buttons -->
    <button onclick="showEditByUser()">Edit by User</button>
    <button onclick="showEditBySubject()">Edit by Subject</button>
    <button onclick="showEditByYearGroup()">Edit by Year Group</button>

    <!-- Edit by User Section -->
    <div id="editByUser" style="display: none;">
        <h3>Edit by User</h3>
        <input type="text" id="searchUser" placeholder="Search users...">
        <table border="1">
            <tr>
                <th>Student Name</th>
                <th>Year Group</th>
                <th>Subjects</th>
                <th>Edit Timetable</th>
            </tr>
            {% for user in users %}
                <tr>
                    <td>{{ user.username }}</td>
                    <td>{% if user.role == 'student' %}{{ user.year_group }}{% else %}None{% endif %}</td>
                    <td>
                        <button type="button" onclick="showSubjects({{ user.id }})">View Subjects</button>
                    </td>
                    <td>
                        <button type="button" onclick="showUserTimetable({{ user.id }})">Edit Timetable</button>
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>

    <!-- Edit by Subject Section -->
    <div id="editBySubject" style="display: none;">
        <h3>Edit by Subject</h3>
        <input type="text" id="searchSubject" placeholder="Search subjects...">
        <table border="1">
            <tr>
                <th>Subject</th>
                <th>Type</th>
                <th>Staff Members</th>
                <th>Students</th>
                <th>Edit Timetables</th>
            </tr>
            {% for subject in subjects %}
                <tr>
                    <td>{{ subject.name }}</td>
                    <td>Subject</td>
                    <td>{{ subject.assigned_users|selectattr('user.role', 'equalto', 'staff')|map(attribute='user.username')|join(', ') }}</td>
                    <td>
                        <button type="button" onclick="showStudents({{ subject.id }})">View Students</button>
                    </td>
                    <td>
                        <button type="button" onclick="showSubjectTimetable({{ subject.id }})">Edit Timetables</button>
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>

    <!-- Edit by Year Group Section -->
    <div id="editByYearGroup" style="display: none;">
        <h3>Edit by Year Group</h3>
        <input type="text" id="searchYearGroup" placeholder="Search year groups...">
        <table border="1">
            <tr>
                <th>Year Group</th>
                <th>Students</th>
                <th>Edit Timetables</th>
            </tr>
            {% for year_group in year_groups %}
                <tr>
                    <td>{{ year_group }}</td>
                    <td>
                        <button type="button" onclick="showYearGroupStudents('{{ year_group }}')">View Students</button>
                    </td>
                    <td>
                        <button type="button" onclick="showYearGroupTimetable('{{ year_group }}')">Edit Timetables</button>
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>

    <!-- Subjects Menu -->
    <div id="subjectsMenu" style="display: none;">
        <h3>Assigned Subjects</h3>
        <ul id="subjectsList"></ul>
        <button type="button" onclick="document.getElementById('subjectsMenu').style.display='none'">Close</button>
    </div>

    <!-- Students Menu -->
    <div id="studentsMenu" style="display: none;">
        <h3>Assigned Students</h3>
        <ul id="studentsList"></ul>
        <button type="button" onclick="document.getElementById('studentsMenu').style.display='none'">Close</button>
    </div>

    {% if selected_user or selected_subject or selected_year_group %}
        <h3>
            Managing timetable for 
            {% if selected_subject %}
                {{ selected_subject.name }} assignees
            {% elif selected_year_group %}
                Year Group {{ selected_year_group }}
            {% else %}
                {{ selected_user.username }}
            {% endif %}
        </h3>

        <!-- Week Navigation -->
        <h3>
            Week: {{ week_range }}
            <button type="button" onclick="changeWeek(-1)">← Previous</button>
            <button type="button" onclick="changeWeek(1)">Next →</button>
        </h3>

        <!-- Step 2: Add Timetable Entry -->
        {% if selected_user %}
            <h3>Add Timetable Entry</h3>
            <form method="post">
                <input type="hidden" name="action" value="add_entry">
                <input type="hidden" name="user_id" value="{{ selected_user.id }}">

                Date: <input type="date" name="date" required><br>
                Start Time: <input type="time" name="start_time" required><br>
                End Time: <input type="time" name="end_time" required><br>

                Select Subject:
                <select name="subject_id" required>
                    {% for assignment in assigned_subjects %}
                        <option value="{{ assignment.subject.id }}">{{ assignment.subject.name }}</option>
                    {% endfor %}
                </select><br>

                Teacher: 
                <select name="teacher_id" required>
                    {% for staff in staff_users %}
                        <option value="{{ staff.id }}">{{ staff.username }}</option>
                    {% endfor %}
                </select><br>

                Select Room:
                <select name="room_id" required>
                    {% for room in rooms %}
                        <option value="{{ room.id }}">{{ room.name }}</option>
                    {% endfor %}
                </select><br>

                <button type="submit">Add Entry</button>
            </form>
        {% endif %}

        <!-- Mass Timetable Entry for Subject Assignees -->
        {% if selected_subject %}
            <form id="timetableForm" method="post">
                <input type="hidden" name="action" value="assign_by_subject">
                <input type="hidden" name="original_subject_id" value="{{ selected_subject.id }}">

                Date: <input type="date" name="date" required><br>
                Start Time: <input type="time" name="start_time" required><br>
                End Time: <input type="time" name="end_time" required><br>

                Select Subject:
                <select name="subject_id" required>
                    {% for subject in subjects %}
                        <option value="{{ subject.id }}">{{ subject.name }}</option>
                    {% endfor %}
                </select><br>

                Select Teacher:
                <select name="teacher_id" required>
                    {% for staff in staff_users %}
                        <option value="{{ staff.id }}">{{ staff.username }}</option>
                    {% endfor %}
                </select><br>

                Select Room:
                <select name="room_id" required>
                    {% for room in rooms %}
                        <option value="{{ room.id }}">{{ room.name }}</option>
                    {% endfor %}
                </select><br>

                <button type="submit">Add Entry</button>
            </form>
        {% endif %}

        <!-- Mass Timetable Entry for Year Group Assignees -->
        {% if selected_year_group %}
            <form id="timetableForm" method="post">
                <input type="hidden" name="action" value="assign_by_year_group">
                <input type="hidden" name="year_group" value="{{ selected_year_group }}">

                Date: <input type="date" name="date" required><br>
                Start Time: <input type="time" name="start_time" required><br>
                End Time: <input type="time" name="end_time" required><br>

                Select Subject:
                <select name="subject_id" required>
                    {% for subject in subjects %}
                        <option value="{{ subject.id }}">{{ subject.name }}</option>
                    {% endfor %}
                </select><br>

                Select Teacher:
                <select name="teacher_id" required>
                    {% for staff in staff_users %}
                        <option value="{{ staff.id }}">{{ staff.username }}</option>
                    {% endfor %}
                </select><br>

                Select Room:
                <select name="room_id" required>
                    {% for room in rooms %}
                        <option value="{{ room.id }}">{{ room.name }}</option>
                    {% endfor %}
                </select><br>

                <button type="submit">Add Entry</button>
            </form>
        {% endif %}
    {% endif %}

    <!-- Step 3: Display Current Week's Timetable -->
    <h3>Timetable for {{ week_range }}</h3>
    {% if timetable %}
        <table border="1">
            <tr>
                {% for day in ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"] %}
                    <th>{{ day }} - {{ (week_start + timedelta(days=loop.index0)).strftime('%d/%m') }}</th>
                {% endfor %}
            </tr>
            <tr>
                {% for day in ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"] %}
                    <td>
                        <ul>
                            {% set unique_entries = {} %}
                            {% for entry in timetable if entry.date.strftime('%A') == day %}
                                {% if entry.entry_id not in unique_entries %}
                                    {% set unique_entries = unique_entries.update({entry.entry_id: true}) %}
                                    <li>
                                        {{ entry.start_time.strftime('%H:%M') }} - {{ entry.end_time.strftime('%H:%M') }}<br>
                                        <strong>{{ entry.subject }}</strong><br>
                                        {{ entry.teacher }}<br>
                                        Room: {{ entry.room if entry.room else "Not assigned" }}<br>
                                        <form method="post" style="display:inline;">
                                            <input type="hidden" name="action" value="delete_entry">
                                            <input type="hidden" name="entry_id" value="{{ entry.id }}">
                                            <button type="submit" onclick="return confirm('Are you sure?')">Delete</button>
                                        </form>
                                        <hr>
                                    </li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    </td>
                {% endfor %}
            </tr>
        </table>
    {% else %}
        <p>No timetable entries for this week.</p>
    {% endif %}

    <p><a href="{{ url_for('admin') }}">Back to Admin Panel</a></p>
    
</body>
</html>
